#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_ROOT"

# Detect Ralph binary (prefer local build, fallback to PATH)
if [[ -x "$REPO_ROOT/target/release/ralph" ]]; then
  RALPH="$REPO_ROOT/target/release/ralph"
elif [[ -x "$REPO_ROOT/target/debug/ralph" ]]; then
  RALPH="$REPO_ROOT/target/debug/ralph"
elif command -v ralph &> /dev/null; then
  RALPH="ralph"
else
  echo "Error: Ralph binary not found"
  echo "Build it with: cargo build --release"
  echo "Or install globally: cargo install --path crates/ralph-cli"
  exit 1
fi

case $1 in
  run)
    shift
    prompt="${1:-Generate content ideas}"

    # Verify inputs exist
    if [[ ! -f .ideation/input/avatar.yaml ]]; then
      echo "Error: .ideation/input/avatar.yaml not found"
      echo "Copy an avatar: cp .ideation/avatars/myla.yaml .ideation/input/avatar.yaml"
      exit 1
    fi

    if [[ ! -f .ideation/input/prompt.md ]]; then
      echo "Error: .ideation/input/prompt.md not found"
      echo "Copy a template: cp .ideation/templates/late-night-techno.md .ideation/input/prompt.md"
      exit 1
    fi

    # Run Ralph with content-ideation preset
    "$RALPH" run -c presets/content-ideation.yml -p "$prompt"
    ;;

  show)
    if [[ ! -f .ideation/output/ideas.yaml ]]; then
      echo "No ideas generated yet. Run: ideate run"
      exit 1
    fi

    # Show passing ideas with color
    echo "=== Passing Ideas (avg >= 7.0) ==="
    yq eval '.ideas[] | select(.status == "passing") |
      "---\nTitle: " + .title +
      "\nHook: " + .hook +
      "\nScore: " + (.avg_score | tostring) +
      "\nCreator: " + .creator +
      "\n"' .ideation/output/ideas.yaml
    ;;

  stats)
    if [[ ! -f .ideation/output/ideas.yaml ]]; then
      echo "No ideas generated yet. Run: ideate run"
      exit 1
    fi

    total=$(yq eval '.ideas | length' .ideation/output/ideas.yaml)
    passing=$(yq eval '.ideas[] | select(.status == "passing") | .id' .ideation/output/ideas.yaml | wc -l)
    failing=$((total - passing))
    rounds=$(yq eval '.rounds' .ideation/output/ideas.yaml)

    echo "=== Ideation Stats ==="
    echo "Rounds: $rounds"
    echo "Total ideas: $total"
    echo "Passing (â‰¥7.0): $passing"
    echo "Failing (<7.0): $failing"
    ;;

  archive)
    if [[ ! -f .ideation/output/ideas.yaml ]]; then
      echo "No ideas to archive"
      exit 1
    fi

    timestamp=$(date +%Y%m%d-%H%M%S)

    # Extract metadata (without yq - use grep/sed for portability)
    avatar=$(grep '^avatar:' .ideation/output/ideas.yaml | sed 's/avatar: *"\?\([^"]*\)"\?/\1/' | tr -d '"')
    theme=$(grep '^theme:' .ideation/output/ideas.yaml | sed 's/theme: *"\?\([^"]*\)"\?/\1/' | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | tr -d '"')

    # Create archive directory structure
    mkdir -p ".ideation/archive/${timestamp}-${avatar}-${theme}"

    # Copy full run
    cp .ideation/output/ideas.yaml ".ideation/archive/${timestamp}-${avatar}-${theme}/all-ideas.yaml"

    # Split passing and failing ideas using awk
    awk '
      BEGIN { in_ideas=0; in_idea=0; passing_count=0; failing_count=0; current_idea="" }
      /^ideas:/ { in_ideas=1; next }
      /^  - id:/ {
        if (current_idea != "" && in_ideas) {
          if (current_status == "passing") {
            print current_idea > ".ideation/archive/'"${timestamp}-${avatar}-${theme}"'/passing-ideas.yaml"
            passing_count++
          } else if (current_status == "failing") {
            print current_idea > ".ideation/archive/'"${timestamp}-${avatar}-${theme}"'/failing-ideas.yaml"
            failing_count++
          }
        }
        current_idea=$0; current_status=""; in_idea=1; next
      }
      in_idea && /^    status:/ {
        current_status=$2; gsub(/"/, "", current_status)
        current_idea=current_idea"\n"$0; next
      }
      in_idea { current_idea=current_idea"\n"$0 }
      END {
        if (current_idea != "" && in_ideas) {
          if (current_status == "passing") {
            print current_idea > ".ideation/archive/'"${timestamp}-${avatar}-${theme}"'/passing-ideas.yaml"
            passing_count++
          } else if (current_status == "failing") {
            print current_idea > ".ideation/archive/'"${timestamp}-${avatar}-${theme}"'/failing-ideas.yaml"
            failing_count++
          }
        }
        print "Passing ideas: " passing_count > "/tmp/ideate-archive-stats"
        print "Failing ideas: " failing_count >> "/tmp/ideate-archive-stats"
      }
    ' .ideation/output/ideas.yaml

    # Read stats
    passing=$(grep "Passing ideas:" /tmp/ideate-archive-stats | cut -d' ' -f3)
    failing=$(grep "Failing ideas:" /tmp/ideate-archive-stats | cut -d' ' -f3)

    echo "Archived to: .ideation/archive/${timestamp}-${avatar}-${theme}/"
    echo "  - all-ideas.yaml (complete run)"
    echo "  - passing-ideas.yaml (${passing} ideas)"
    if [[ "$failing" -gt 0 ]]; then
      echo "  - failing-ideas.yaml (${failing} ideas)"
    fi
    ;;

  split)
    if [[ ! -f .ideation/output/ideas.yaml ]]; then
      echo "No ideas to split"
      exit 1
    fi

    # Split passing and failing ideas
    awk '
      BEGIN { in_ideas=0; passing=""; failing=""; header="" }
      /^ideas:/ { in_ideas=1; print > ".ideation/output/passing-ideas.yaml"; print > ".ideation/output/failing-ideas.yaml"; next }
      !in_ideas { header=header $0 "\n"; print > ".ideation/output/passing-ideas.yaml"; print > ".ideation/output/failing-ideas.yaml"; next }
      /^  - id:/ { current_idea=$0; current_status=""; next }
      /^    status:/ { current_status=$2; gsub(/"/, "", current_status); current_idea=current_idea"\n"$0; next }
      { current_idea=current_idea"\n"$0 }
      /^$/ && current_idea != "" {
        if (current_status == "passing") {
          print current_idea > ".ideation/output/passing-ideas.yaml"
        } else if (current_status == "failing") {
          print current_idea > ".ideation/output/failing-ideas.yaml"
        }
        current_idea=""
      }
      END {
        if (current_idea != "") {
          if (current_status == "passing") {
            print current_idea > ".ideation/output/passing-ideas.yaml"
          } else if (current_status == "failing") {
            print current_idea > ".ideation/output/failing-ideas.yaml"
          }
        }
      }
    ' .ideation/output/ideas.yaml

    passing_count=$(grep -c "^  - id:" .ideation/output/passing-ideas.yaml 2>/dev/null || echo "0")
    failing_count=$(grep -c "^  - id:" .ideation/output/failing-ideas.yaml 2>/dev/null || echo "0")

    echo "Split ideas into separate files:"
    echo "  - .ideation/output/passing-ideas.yaml (${passing_count} ideas)"
    echo "  - .ideation/output/failing-ideas.yaml (${failing_count} ideas)"
    ;;

  clean)
    rm -f .ideation/output/ideas.yaml
    rm -f .ideation/output/passing-ideas.yaml
    rm -f .ideation/output/failing-ideas.yaml
    rm -f .ideation/PROMPT.md
    echo "Cleared output files"
    ;;

  setup)
    avatar="${2:-myla}"
    template="${3:-late-night-techno}"

    if [[ ! -f ".ideation/avatars/${avatar}.yaml" ]]; then
      echo "Error: Avatar not found: .ideation/avatars/${avatar}.yaml"
      exit 1
    fi

    if [[ ! -f ".ideation/templates/${template}.md" ]]; then
      echo "Error: Template not found: .ideation/templates/${template}.md"
      exit 1
    fi

    cp ".ideation/avatars/${avatar}.yaml" .ideation/input/avatar.yaml
    cp ".ideation/templates/${template}.md" .ideation/input/prompt.md

    echo "Setup complete:"
    echo "  Avatar: ${avatar}"
    echo "  Template: ${template}"
    echo ""
    echo "Edit prompt: \$EDITOR .ideation/input/prompt.md"
    echo "Run ideation: ideate run"
    ;;

  *)
    echo "Usage: ideate [command]"
    echo ""
    echo "Commands:"
    echo "  setup [avatar] [template]  - Copy avatar and template to input/ (default: myla late-night-techno)"
    echo "  run [prompt]               - Run ideation loop (default prompt: 'Generate content ideas')"
    echo "  show                       - Show passing ideas"
    echo "  stats                      - Show ideation statistics"
    echo "  split                      - Split ideas into passing and failing files"
    echo "  archive                    - Archive current ideas with timestamp (auto-splits by status)"
    echo "  clean                      - Clear output files"
    echo ""
    echo "Examples:"
    echo "  ideate setup myla late-night-techno"
    echo "  ideate run"
    echo "  ideate show"
    echo "  ideate split               # Split into passing/failing files"
    echo "  ideate archive             # Archive with automatic splitting"
    exit 1
    ;;
esac
