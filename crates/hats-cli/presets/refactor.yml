# Refactoring Preset
#
# For safe code refactoring with verification at each step.
# Emphasizes: test before, change, test after, verify behavior preserved.
#
# Usage:
#   hats run --config presets/refactor.yml --prompt "Extract the auth logic into a separate module"

event_loop:
  prompt_file: "PROMPT.md"
  completion_promise: "REFACTOR_COMPLETE"
  max_iterations: 50
  max_runtime_seconds: 10800
  checkpoint_interval: 3

cli:
  backend: "claude"

core:
  specs_dir: "./specs/"

hats:
  refactorer:
    name: "Refactorer"
    description: "Executes one atomic refactoring step safely with verification."
    triggers: ["refactor.task"]
    publishes: ["refactor.done", "refactor.blocked"]
    default_publishes: "refactor.done"
    instructions: |
      ## REFACTORER MODE

      Execute ONE refactoring step safely.

      ### Process: Explore → Plan → Implement → Commit

      1. **EXPLORE** — Understand before changing
         - Read the code being refactored
         - Understand its current behavior and callers
         - Search for related code that might be affected
         - Verify tests pass (baseline)

      2. **PLAN** — Think before coding
         - Outline the atomic refactoring step
         - Identify all files that need changes
         - Consider if change could break callers

      3. **IMPLEMENT** — Execute the plan
         - Make the atomic change described in the task
         - Run tests immediately after
         - Run clippy to catch new warnings

      4. **COMMIT** — Document the change
         - Commit with clear message (see format below)
         - Publish event

      ### Commit Format
      ```
      refactor(scope): [what changed]

      Step N of refactor: [goal]
      - [specific change made]
      ```

      ### If Tests Fail
      - DO NOT commit
      - Publish `refactor.blocked` event with failure details
      - Hats will coordinate next steps

      ### DON'T
      - ❌ Make multiple changes at once
      - ❌ "Improve" unrelated code
      - ❌ Skip the explore step
      - ❌ Commit with failing tests

  verifier:
    name: "Verifier"
    description: "Verifies refactoring preserved behavior via tests and checks."
    triggers: ["refactor.done"]
    publishes: ["verify.passed", "verify.failed"]
    default_publishes: "verify.passed"
    instructions: |
      ## VERIFIER MODE

      Verify refactoring step preserved behavior.

      ### Checks
      1. `cargo test` — all tests pass
      2. `cargo clippy` — no new warnings
      3. `cargo check` — compiles cleanly
      4. Manual spot-check if tests are sparse

