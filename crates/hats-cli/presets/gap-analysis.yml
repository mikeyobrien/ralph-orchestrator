# Gap Analysis Preset
#
# Deep comparison of specs against implementation.
# Produces structured findings in ISSUES.md.
#
# Usage:
#   hats run --config presets/gap-analysis.yml
#   hats run --config presets/gap-analysis.yml -p "Focus on cli-adapters.spec.md"

event_loop:
  starting_event: "gap.start"  # Hats publishes this after coordination
  prompt: |
    Perform a deep gap analysis between specs and implementation.

    ## Objective
    Compare each spec in ./specs/ against the actual implementation.
    Document all discrepancies, missing features, and spec violations.

    ## Process
    1. Read each spec file in ./specs/
    2. For each acceptance criterion, verify it's implemented correctly
    3. Check for undocumented behavior (implementation without spec)
    4. Document findings in ISSUES.md

    ## Output Format (ISSUES.md)
    ```markdown
    # Gap Analysis Results

    > Analysis date: YYYY-MM-DD
    > Specs analyzed: N

    ## Critical Gaps (Spec Violations)
    - **spec-name.spec.md** — [description]
      - Spec says: [quote from spec]
      - Implementation: [what actually happens]
      - Location: `file:line`

    ## Missing Features (Spec Not Implemented)
    - **spec-name.spec.md** — [feature]
      - Acceptance criterion: [quote]
      - Status: Not found in codebase

    ## Undocumented Behavior (Implementation Without Spec)
    - **file.rs** — [behavior]
      - Should be documented in: [suggested spec]

    ## Spec Improvements Needed
    - **spec-name.spec.md** — [issue]
      - Problem: [ambiguity, missing detail, etc.]
      - Suggestion: [how to fix]
    ```

    ## Success Criteria
    - All specs in ./specs/ analyzed
    - ISSUES.md written with findings
    - gap_analysis dates updated in spec frontmatter
  completion_promise: "GAP_ANALYSIS_COMPLETE"
  max_iterations: 50
  max_runtime_seconds: 7200

cli:
  backend: "claude"

core:
  specs_dir: "./specs/"

hats:
  analyzer:
    name: "Gap Analyzer"
    description: "Coordinates gap analysis between specs and implementation."
    triggers: ["gap.start", "verify.complete", "report.complete"]
    publishes: ["analyze.spec", "verify.request", "report.request"]
    instructions: |
      ## GAP ANALYZER MODE

      You're coordinating the gap analysis.

      ### Process
      1. **Inventory specs.** List all specs in ./specs/ and track progress.
      2. **Dispatch analysis.** Publish `analyze.spec` for each spec.
      3. **Request verification.** After analysis, dispatch `verify.request`.
      4. **Request report.** After verification, dispatch `report.request`.
      5. **Update frontmatter.** Set `gap_analysis: YYYY-MM-DD` in analyzed specs.

      ### DON'T
      - Don't read implementation code deeply (that's verifier's job)
      - Don't write ISSUES.md (that's reporter's job)
      - Don't skip any spec

      ### DONE
      When ISSUES.md is written and all specs have updated gap_analysis dates:
      GAP_ANALYSIS_COMPLETE

  verifier:
    name: "Implementation Verifier"
    description: "Deep-dives into code to verify spec compliance."
    triggers: ["analyze.spec", "verify.request"]
    publishes: ["verify.complete"]
    instructions: |
      ## IMPLEMENTATION VERIFIER MODE

      Deep-dive into code to verify spec compliance.

      ### For Each Acceptance Criterion
      1. **Find the implementation.** Search codebase for relevant code.
      2. **Trace the code path.** Understand what actually happens.
      3. **Compare to spec.** Does behavior match acceptance criteria?
      4. **Document gaps.** Record findings for the report.

      ### Verification Checklist
      - [ ] Happy path works as specified
      - [ ] Error cases handled as specified
      - [ ] Edge cases covered
      - [ ] Config options work as documented
      - [ ] CLI flags work as documented

      ### DON'T
      - Don't modify any code
      - Don't assume "probably works" — verify
      - Don't skip error handling checks

      ### Output
      Record findings for the spec being verified.
      Publish `verify.complete` when done with current spec.

  reporter:
    name: "Gap Reporter"
    description: "Compiles findings into structured ISSUES.md report."
    triggers: ["report.request"]
    publishes: ["report.complete"]
    instructions: |
      ## GAP REPORTER MODE

      Compile findings into structured ISSUES.md.

      ### Process
      1. **Gather findings.** Collect all findings from analysis.
      2. **Categorize.** Group by severity (critical, missing, undocumented, improvements).
      3. **Write ISSUES.md.** Use the format from the prompt.
      4. **Be specific.** Include file:line references, spec quotes, code snippets.

      ### Severity Categories

      **Critical (Spec Violations):**
      - Implementation contradicts spec
      - Acceptance criterion fails
      - Security implications

      **Missing Features:**
      - Acceptance criterion not implemented
      - Documented behavior missing

      **Undocumented Behavior:**
      - Code does something spec doesn't mention
      - May need spec update or code removal

      **Spec Improvements:**
      - Ambiguous wording
      - Missing edge cases
      - Outdated information

      ### DON'T
      - Don't include non-issues (things that work correctly)
      - Don't be vague ("something is wrong")
      - Don't suggest fixes (just document gaps)

      ### Output
      Write findings to ISSUES.md. Publish `report.complete` when done.

# ─────────────────────────────────────────────────────────────────────────────
# Gap Analysis Reference
# ─────────────────────────────────────────────────────────────────────────────
#
# What Makes a Good Gap Analysis:
#
#   1. Exhaustive — Every spec, every acceptance criterion
#   2. Specific — File:line references, not vague descriptions
#   3. Objective — Document facts, not opinions
#   4. Actionable — Each finding can be addressed
#
# Common Gap Types:
#
#   - Missing implementation: Spec says X, code doesn't do X
#   - Wrong implementation: Spec says X, code does Y
#   - Missing error handling: Spec says "error if X", no error thrown
#   - Missing config: Spec mentions option, not in schema
#   - Outdated spec: Code changed, spec not updated
#   - Missing spec: Code does something undocumented
# ─────────────────────────────────────────────────────────────────────────────
